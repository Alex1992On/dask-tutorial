

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Bag: Parallel Lists for semi-structured data &mdash; Dask Tutorial  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/style.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/explore.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/nbsphinx.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
        <script src="_static/js/custom.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Arrays" href="03_array.html" />
    <link rel="prev" title="Lazy execution" href="01x_lazy.html" />
  <link rel="shortcut icon" href="_static/images/favicon.ico"/>
  
  <meta name="Description" content="Bag: Parallel Lists for semi-structured data">
  <meta property="og:description" content="Bag: Parallel Lists for semi-structured data">
  <meta name="twitter:description" content="Bag: Parallel Lists for semi-structured data" />
  <meta property="og:title" content="Dask Tutorial  documentation - Bag: Parallel Lists for semi-structured data">
  <meta property="og:image" content="https://github.com/dask.png">
  <meta property="og:image:secure_url" content="https://github.com/dask.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="380" />
  <meta property="og:image:height" content="380" />
  <meta property="og:url" content="02_bag.html">
  <meta property="og:site_name" content="Dask Tutorial  documentation">

  <meta name="twitter:site" content="https://dask.org" />
  <meta name="twitter:creator" content="@dask_dev" />
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="https://github.com/dask.png" />
  <meta name="twitter:image:alt" content="Dask Tutorial  documentation">
  

</head>

<body class="wy-body-for-nav">

  
    <nav id="explore-links">
        <a href="https://docs.dask.org/">
        <img class="caption" src="_static/images/dask-horizontal-white.svg"/>
        </a>

        <ul>
        <li>
            <a>Get Started</a>
            <ul>
            <li><a href="https://docs.dask.org/en/latest/install.html"> Install </a></li>
            <li><a href="https://examples.dask.org"> Examples </a></li>
            <li><a href="https://github.com/dask/dask-tutorial"> Tutorial </a></li>
            <li><a href="https://docs.dask.org/en/latest/why.html"> Why Dask? </a></li>
            <li><a href="https://stories.dask.org/en/latest"> Use Cases </a></li>
            <li><a href="https://www.youtube.com/watch?v=RA_2qdipVng&list=PLRtz5iA93T4PQvWuoMnIyEIz1fXiJ5Pri"> Talks </a></li>
            <li><a href="https://mybinder.org/v2/gh/dask/dask-examples/master?urlpath=lab"> Try Online </a></li>
            <li><a href="https://dask.org/slides"> Slides </a></li>
            </ul>
        </li>

        <li>
            <a href="">Algorithms</a>
            <ul>
            <li><a href="https://docs.dask.org/en/latest/array.html">Arrays</a></li>
            <li><a href="https://docs.dask.org/en/latest/dataframe.html">Dataframes</a></li>
            <li><a href="https://docs.dask.org/en/latest/bag.html">Bags</a></li>
            <li><a href="https://docs.dask.org/en/latest/delayed.html">Delayed (custom)</a></li>
            <li><a href="https://docs.dask.org/en/latest/futures.html">Futures (real-time)</a></li>
            <li><a href="http://ml.dask.org">Machine Learning</a></li>
            <li><a href="https://xarray.pydata.org/en/latest/">XArray</a></li>
            </ul>
        </li>

        <li>
            <a href="https://docs.dask.org/en/latest/setup.html">Setup</a>
            <ul>
            <li><a href="https://docs.dask.org/en/latest/setup/single-machine.html"> Local </a></li>
            <li><a href="https://docs.dask.org/en/latest/setup/cloud.html"> Cloud </a></li>
            <li><a href="https://docs.dask.org/en/latest/setup/hpc.html"> HPC </a></li>
            <li><a href="https://kubernetes.dask.org/en/latest/"> Kubernetes </a></li>
            <li><a href="https://yarn.dask.org/en/latest/"> Hadoop / Yarn </a></li>
            </ul>
        </li>

        <li>
            <a>Community</a>
            <ul>
            <li><a href="http://docs.dask.org/en/latest/support.html">Ask for Help</a></li>
            <li><a href="https://github.com/dask">Github</a></li>
            <li><a href="https://stackoverflow.com/questions/tagged/dask">Stack Overflow</a></li>
            <li><a href="https://twitter.com/dask_dev">Twitter</a></li>
            <li><a href="https://blog.dask.org/"> Developer Blog </a></li>
            <li><a href="https://youtube.com/c/dask-dev"> YouTube Channel </a></li>
            </ul>
        </li>
        </ul>

    </nav>
  
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Dask Tutorial
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="00_overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_dask.delayed.html">Parallelize code with <code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="01x_lazy.html">Lazy execution</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bag: Parallel Lists for semi-structured data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Create-data">Create data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Creation">Creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Manipulation">Manipulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Example:-Accounts-JSON-data">Example: Accounts JSON data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Basic-Queries">Basic Queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Use-flatten-to-de-nest">Use <code class="docutils literal notranslate"><span class="pre">flatten</span></code> to de-nest</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Groupby-and-Foldby">Groupby and Foldby</a></li>
<li class="toctree-l3"><a class="reference internal" href="#groupby"><code class="docutils literal notranslate"><span class="pre">groupby</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#foldby"><code class="docutils literal notranslate"><span class="pre">foldby</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example-with-account-data">Example with account data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Exercise:-compute-total-amount-per-name">Exercise: compute total amount per name</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#DataFrames">DataFrames</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Denormalization">Denormalization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Learn-More">Learn More</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Shutdown">Shutdown</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="03_array.html">Arrays</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_dataframe.html">Dask DataFrames</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_distributed.html">Distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_distributed_advanced.html">Distributed, Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_dataframe_storage.html">Data Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_machine_learning.html">Parallel and Distributed Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_machine_learning.html#Training-on-Large-Datasets">Training on Large Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="Homework.html">Homework</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Dask Tutorial</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Bag: Parallel Lists for semi-structured data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/02_bag.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<p>You can run this notebook in a <a class="reference external" href="https://mybinder.org/v2/gh/dask/dask-tutorial/master?urlpath=lab/tree/02_bag.ipynb">live session</a> <a class="reference external" href="https://mybinder.org/v2/gh/dask/dask-tutorial/master?urlpath=lab/tree/02_bag.ipynb"><img alt="Binder" src="https://mybinder.org/badge.svg" /></a> or view it <a class="reference external" href="https://github.com/dask/dask-tutorial/blob/master/02_bag.ipynb">on Github</a>.</p>
<p><img alt="9c2c6f05a8744f609175a8c26b8a494d" class="no-scaled-link" src="_images/dask_horizontal.svg" width="30%" /></p>
<div class="section" id="Bag:-Parallel-Lists-for-semi-structured-data">
<h1>Bag: Parallel Lists for semi-structured data<a class="headerlink" href="#Bag:-Parallel-Lists-for-semi-structured-data" title="Permalink to this headline">¶</a></h1>
<p>Dask-bag excels in processing data that can be represented as a sequence of arbitrary inputs. We’ll refer to this as “messy” data, because it can contain complex nested structures, missing fields, mixtures of data types, etc. The <em>functional</em> programming style fits very nicely with standard Python iteration, such as can be found in the <code class="docutils literal notranslate"><span class="pre">itertools</span></code> module.</p>
<p>Messy data is often encountered at the beginning of data processing pipelines when large volumes of raw data are first consumed. The initial set of data might be JSON, CSV, XML, or any other format that does not enforce strict structure and datatypes. For this reason, the initial data massaging and processing is often done with Python <code class="docutils literal notranslate"><span class="pre">list</span></code>s, <code class="docutils literal notranslate"><span class="pre">dict</span></code>s, and <code class="docutils literal notranslate"><span class="pre">set</span></code>s.</p>
<p>These core data structures are optimized for general-purpose storage and processing. Adding streaming computation with iterators/generator expressions or libraries like <code class="docutils literal notranslate"><span class="pre">itertools</span></code> or <code class="docutils literal notranslate"><span class="pre">`toolz</span></code> &lt;<a class="reference external" href="https://toolz.readthedocs.io/en/latest/">https://toolz.readthedocs.io/en/latest/</a>&gt;`__ let us process large volumes in a small space. If we combine this with parallel processing then we can churn through a fair amount of data.</p>
<p>Dask.bag is a high level Dask collection to automate common workloads of this form. In a nutshell</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">bag</span> <span class="o">=</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">toolz</span> <span class="o">+</span> <span class="n">parallel</span> <span class="n">execution</span>
</pre></div>
</div>
<p><strong>Related Documentation</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/bag.html">Bag documentation</a></p></li>
<li><p><a class="reference external" href="https://youtu.be/-qIiJ1XtSv0">Bag screencast</a></p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/bag-api.html">Bag API</a></p></li>
<li><p><a class="reference external" href="https://examples.dask.org/bag.html">Bag examples</a></p></li>
</ul>
<div class="section" id="Create-data">
<h2>Create data<a class="headerlink" href="#Create-data" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">run</span> prep.py -d accounts
</pre></div>
</div>
</div>
</div>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>Again, we’ll use the distributed scheduler. Schedulers will be explained in depth <a class="reference internal" href="05_distributed.html"><span class="doc">later</span></a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Creation">
<h2>Creation<a class="headerlink" href="#Creation" title="Permalink to this headline">¶</a></h2>
<p>You can create a <code class="docutils literal notranslate"><span class="pre">Bag</span></code> from a Python sequence, from files, from data on S3, etc. We demonstrate using <code class="docutils literal notranslate"><span class="pre">.take()</span></code> to show elements of the data. (Doing <code class="docutils literal notranslate"><span class="pre">.take(1)</span></code> results in a tuple with one element)</p>
<p>Note that the data are partitioned into blocks, and there are many items per block. In the first example, the two partitions contain five elements each, and in the following two, each file is partitioned into one or more bytes blocks.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># each element is an integer</span>
<span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">npartitions</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">b</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 2, 3)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># each element is a text file, where each line is a JSON object</span>
<span class="c1"># note that the compression is handled automatically</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;accounts.*.json.gz&#39;</span><span class="p">))</span>
<span class="n">b</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;{&#34;id&#34;: 0, &#34;name&#34;: &#34;Frank&#34;, &#34;transactions&#34;: [{&#34;transaction-id&#34;: 1923, &#34;amount&#34;: 927}, {&#34;transaction-id&#34;: 3779, &#34;amount&#34;: 853}]}\n&#39;,)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Edit sources.py to configure source locations</span>
<span class="kn">import</span> <span class="nn">sources</span>
<span class="n">sources</span><span class="o">.</span><span class="n">bag_url</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;s3://dask-data/nyc-taxi/2015/yellow_tripdata_2015-01.csv&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Requires `s3fs` library</span>
<span class="c1"># each partition is a remote CSV text file</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">bag_url</span><span class="p">,</span>
                 <span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;anon&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">b</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;VendorID,tpep_pickup_datetime,tpep_dropoff_datetime,passenger_count,trip_distance,pickup_longitude,pickup_latitude,RateCodeID,store_and_fwd_flag,dropoff_longitude,dropoff_latitude,payment_type,fare_amount,extra,mta_tax,tip_amount,tolls_amount,improvement_surcharge,total_amount\n&#39;,)
</pre></div></div>
</div>
</div>
<div class="section" id="Manipulation">
<h2>Manipulation<a class="headerlink" href="#Manipulation" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Bag</span></code> objects hold the standard functional API found in projects like the Python standard library, <code class="docutils literal notranslate"><span class="pre">toolz</span></code>, or <code class="docutils literal notranslate"><span class="pre">pyspark</span></code>, including <code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code>, <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, etc..</p>
<p>Operations on <code class="docutils literal notranslate"><span class="pre">Bag</span></code> objects create new bags. Call the <code class="docutils literal notranslate"><span class="pre">.compute()</span></code> method to trigger execution, as we saw for <code class="docutils literal notranslate"><span class="pre">Delayed</span></code> objects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">is_even</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_even</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">c</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dask.bag&lt;lambda, npartitions=10&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># blocking form: wait for completion (which is very fast in this case)</span>
<span class="n">c</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[4, 16, 36, 64, 100]
</pre></div></div>
</div>
<div class="section" id="Example:-Accounts-JSON-data">
<h3>Example: Accounts JSON data<a class="headerlink" href="#Example:-Accounts-JSON-data" title="Permalink to this headline">¶</a></h3>
<p>We’ve created a fake dataset of gzipped JSON data in your data directory. This is like the example used in the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> example we will see later, except that it has bundled up all of the entires for each individual <code class="docutils literal notranslate"><span class="pre">id</span></code> into a single record. This is similar to data that you might collect off of a document store database or a web API.</p>
<p>Each line is a JSON encoded dictionary with the following keys</p>
<ul class="simple">
<li><p>id: Unique identifier of the customer</p></li>
<li><p>name: Name of the customer</p></li>
<li><p>transactions: List of <code class="docutils literal notranslate"><span class="pre">transaction-id</span></code>, <code class="docutils literal notranslate"><span class="pre">amount</span></code> pairs, one for each transaction for the customer in that file</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;accounts.*.json.gz&#39;</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">lines</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;{&#34;id&#34;: 0, &#34;name&#34;: &#34;Frank&#34;, &#34;transactions&#34;: [{&#34;transaction-id&#34;: 1923, &#34;amount&#34;: 927}, {&#34;transaction-id&#34;: 3779, &#34;amount&#34;: 853}]}\n&#39;,
 &#39;{&#34;id&#34;: 1, &#34;name&#34;: &#34;Charlie&#34;, &#34;transactions&#34;: [{&#34;transaction-id&#34;: 184, &#34;amount&#34;: 561}, {&#34;transaction-id&#34;: 591, &#34;amount&#34;: 546}, {&#34;transaction-id&#34;: 1235, &#34;amount&#34;: 551}, {&#34;transaction-id&#34;: 1627, &#34;amount&#34;: 511}, {&#34;transaction-id&#34;: 1936, &#34;amount&#34;: 547}, {&#34;transaction-id&#34;: 2032, &#34;amount&#34;: 543}, {&#34;transaction-id&#34;: 2216, &#34;amount&#34;: 563}, {&#34;transaction-id&#34;: 2457, &#34;amount&#34;: 547}, {&#34;transaction-id&#34;: 2526, &#34;amount&#34;: 539}, {&#34;transaction-id&#34;: 3454, &#34;amount&#34;: 471}, {&#34;transaction-id&#34;: 3702, &#34;amount&#34;: 546}, {&#34;transaction-id&#34;: 4154, &#34;amount&#34;: 609}, {&#34;transaction-id&#34;: 4218, &#34;amount&#34;: 602}, {&#34;transaction-id&#34;: 4425, &#34;amount&#34;: 574}, {&#34;transaction-id&#34;: 4434, &#34;amount&#34;: 564}, {&#34;transaction-id&#34;: 4495, &#34;amount&#34;: 539}, {&#34;transaction-id&#34;: 4689, &#34;amount&#34;: 529}, {&#34;transaction-id&#34;: 4925, &#34;amount&#34;: 617}, {&#34;transaction-id&#34;: 4951, &#34;amount&#34;: 567}, {&#34;transaction-id&#34;: 5601, &#34;amount&#34;: 520}, {&#34;transaction-id&#34;: 5649, &#34;amount&#34;: 552}, {&#34;transaction-id&#34;: 5804, &#34;amount&#34;: 537}, {&#34;transaction-id&#34;: 7279, &#34;amount&#34;: 537}, {&#34;transaction-id&#34;: 7486, &#34;amount&#34;: 577}, {&#34;transaction-id&#34;: 8273, &#34;amount&#34;: 547}, {&#34;transaction-id&#34;: 8310, &#34;amount&#34;: 555}, {&#34;transaction-id&#34;: 8396, &#34;amount&#34;: 567}, {&#34;transaction-id&#34;: 8427, &#34;amount&#34;: 548}, {&#34;transaction-id&#34;: 8990, &#34;amount&#34;: 554}, {&#34;transaction-id&#34;: 9291, &#34;amount&#34;: 547}, {&#34;transaction-id&#34;: 9638, &#34;amount&#34;: 573}, {&#34;transaction-id&#34;: 9858, &#34;amount&#34;: 559}, {&#34;transaction-id&#34;: 9904, &#34;amount&#34;: 552}, {&#34;transaction-id&#34;: 9917, &#34;amount&#34;: 536}]}\n&#39;,
 &#39;{&#34;id&#34;: 2, &#34;name&#34;: &#34;Xavier&#34;, &#34;transactions&#34;: [{&#34;transaction-id&#34;: 282, &#34;amount&#34;: 29}, {&#34;transaction-id&#34;: 571, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 603, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 893, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 900, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 1134, &#34;amount&#34;: 41}, {&#34;transaction-id&#34;: 1588, &#34;amount&#34;: 37}, {&#34;transaction-id&#34;: 1962, &#34;amount&#34;: 31}, {&#34;transaction-id&#34;: 2074, &#34;amount&#34;: 29}, {&#34;transaction-id&#34;: 2116, &#34;amount&#34;: 36}, {&#34;transaction-id&#34;: 2150, &#34;amount&#34;: 36}, {&#34;transaction-id&#34;: 2154, &#34;amount&#34;: 31}, {&#34;transaction-id&#34;: 2220, &#34;amount&#34;: 38}, {&#34;transaction-id&#34;: 2978, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 2989, &#34;amount&#34;: 37}, {&#34;transaction-id&#34;: 3864, &#34;amount&#34;: 30}, {&#34;transaction-id&#34;: 3874, &#34;amount&#34;: 36}, {&#34;transaction-id&#34;: 3962, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 4377, &#34;amount&#34;: 36}, {&#34;transaction-id&#34;: 5167, &#34;amount&#34;: 36}, {&#34;transaction-id&#34;: 5180, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 5211, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 5341, &#34;amount&#34;: 31}, {&#34;transaction-id&#34;: 5358, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 5550, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 5733, &#34;amount&#34;: 29}, {&#34;transaction-id&#34;: 5844, &#34;amount&#34;: 32}, {&#34;transaction-id&#34;: 6046, &#34;amount&#34;: 35}, {&#34;transaction-id&#34;: 6220, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 6224, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 6519, &#34;amount&#34;: 35}, {&#34;transaction-id&#34;: 6636, &#34;amount&#34;: 35}, {&#34;transaction-id&#34;: 6802, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 6935, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 6953, &#34;amount&#34;: 31}, {&#34;transaction-id&#34;: 7006, &#34;amount&#34;: 35}, {&#34;transaction-id&#34;: 7064, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 7423, &#34;amount&#34;: 37}, {&#34;transaction-id&#34;: 7758, &#34;amount&#34;: 37}, {&#34;transaction-id&#34;: 8055, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 8150, &#34;amount&#34;: 38}, {&#34;transaction-id&#34;: 8185, &#34;amount&#34;: 37}, {&#34;transaction-id&#34;: 8428, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 8497, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 8563, &#34;amount&#34;: 33}, {&#34;transaction-id&#34;: 8690, &#34;amount&#34;: 35}, {&#34;transaction-id&#34;: 8910, &#34;amount&#34;: 36}, {&#34;transaction-id&#34;: 9489, &#34;amount&#34;: 32}, {&#34;transaction-id&#34;: 9649, &#34;amount&#34;: 34}, {&#34;transaction-id&#34;: 9665, &#34;amount&#34;: 35}, {&#34;transaction-id&#34;: 9797, &#34;amount&#34;: 33}]}\n&#39;)
</pre></div></div>
</div>
<p>Our data comes out of the file as lines of text. Notice that file decompression happened automatically. We can make this data look more reasonable by mapping the <code class="docutils literal notranslate"><span class="pre">json.loads</span></code> function onto our bag.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="n">js</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
<span class="c1"># take: inspect first few elements</span>
<span class="n">js</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
({&#39;id&#39;: 0,
  &#39;name&#39;: &#39;Frank&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 1923, &#39;amount&#39;: 927},
   {&#39;transaction-id&#39;: 3779, &#39;amount&#39;: 853}]},
 {&#39;id&#39;: 1,
  &#39;name&#39;: &#39;Charlie&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 184, &#39;amount&#39;: 561},
   {&#39;transaction-id&#39;: 591, &#39;amount&#39;: 546},
   {&#39;transaction-id&#39;: 1235, &#39;amount&#39;: 551},
   {&#39;transaction-id&#39;: 1627, &#39;amount&#39;: 511},
   {&#39;transaction-id&#39;: 1936, &#39;amount&#39;: 547},
   {&#39;transaction-id&#39;: 2032, &#39;amount&#39;: 543},
   {&#39;transaction-id&#39;: 2216, &#39;amount&#39;: 563},
   {&#39;transaction-id&#39;: 2457, &#39;amount&#39;: 547},
   {&#39;transaction-id&#39;: 2526, &#39;amount&#39;: 539},
   {&#39;transaction-id&#39;: 3454, &#39;amount&#39;: 471},
   {&#39;transaction-id&#39;: 3702, &#39;amount&#39;: 546},
   {&#39;transaction-id&#39;: 4154, &#39;amount&#39;: 609},
   {&#39;transaction-id&#39;: 4218, &#39;amount&#39;: 602},
   {&#39;transaction-id&#39;: 4425, &#39;amount&#39;: 574},
   {&#39;transaction-id&#39;: 4434, &#39;amount&#39;: 564},
   {&#39;transaction-id&#39;: 4495, &#39;amount&#39;: 539},
   {&#39;transaction-id&#39;: 4689, &#39;amount&#39;: 529},
   {&#39;transaction-id&#39;: 4925, &#39;amount&#39;: 617},
   {&#39;transaction-id&#39;: 4951, &#39;amount&#39;: 567},
   {&#39;transaction-id&#39;: 5601, &#39;amount&#39;: 520},
   {&#39;transaction-id&#39;: 5649, &#39;amount&#39;: 552},
   {&#39;transaction-id&#39;: 5804, &#39;amount&#39;: 537},
   {&#39;transaction-id&#39;: 7279, &#39;amount&#39;: 537},
   {&#39;transaction-id&#39;: 7486, &#39;amount&#39;: 577},
   {&#39;transaction-id&#39;: 8273, &#39;amount&#39;: 547},
   {&#39;transaction-id&#39;: 8310, &#39;amount&#39;: 555},
   {&#39;transaction-id&#39;: 8396, &#39;amount&#39;: 567},
   {&#39;transaction-id&#39;: 8427, &#39;amount&#39;: 548},
   {&#39;transaction-id&#39;: 8990, &#39;amount&#39;: 554},
   {&#39;transaction-id&#39;: 9291, &#39;amount&#39;: 547},
   {&#39;transaction-id&#39;: 9638, &#39;amount&#39;: 573},
   {&#39;transaction-id&#39;: 9858, &#39;amount&#39;: 559},
   {&#39;transaction-id&#39;: 9904, &#39;amount&#39;: 552},
   {&#39;transaction-id&#39;: 9917, &#39;amount&#39;: 536}]},
 {&#39;id&#39;: 2,
  &#39;name&#39;: &#39;Xavier&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 282, &#39;amount&#39;: 29},
   {&#39;transaction-id&#39;: 571, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 603, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 893, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 900, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 1134, &#39;amount&#39;: 41},
   {&#39;transaction-id&#39;: 1588, &#39;amount&#39;: 37},
   {&#39;transaction-id&#39;: 1962, &#39;amount&#39;: 31},
   {&#39;transaction-id&#39;: 2074, &#39;amount&#39;: 29},
   {&#39;transaction-id&#39;: 2116, &#39;amount&#39;: 36},
   {&#39;transaction-id&#39;: 2150, &#39;amount&#39;: 36},
   {&#39;transaction-id&#39;: 2154, &#39;amount&#39;: 31},
   {&#39;transaction-id&#39;: 2220, &#39;amount&#39;: 38},
   {&#39;transaction-id&#39;: 2978, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 2989, &#39;amount&#39;: 37},
   {&#39;transaction-id&#39;: 3864, &#39;amount&#39;: 30},
   {&#39;transaction-id&#39;: 3874, &#39;amount&#39;: 36},
   {&#39;transaction-id&#39;: 3962, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 4377, &#39;amount&#39;: 36},
   {&#39;transaction-id&#39;: 5167, &#39;amount&#39;: 36},
   {&#39;transaction-id&#39;: 5180, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 5211, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 5341, &#39;amount&#39;: 31},
   {&#39;transaction-id&#39;: 5358, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 5550, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 5733, &#39;amount&#39;: 29},
   {&#39;transaction-id&#39;: 5844, &#39;amount&#39;: 32},
   {&#39;transaction-id&#39;: 6046, &#39;amount&#39;: 35},
   {&#39;transaction-id&#39;: 6220, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 6224, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 6519, &#39;amount&#39;: 35},
   {&#39;transaction-id&#39;: 6636, &#39;amount&#39;: 35},
   {&#39;transaction-id&#39;: 6802, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 6935, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 6953, &#39;amount&#39;: 31},
   {&#39;transaction-id&#39;: 7006, &#39;amount&#39;: 35},
   {&#39;transaction-id&#39;: 7064, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 7423, &#39;amount&#39;: 37},
   {&#39;transaction-id&#39;: 7758, &#39;amount&#39;: 37},
   {&#39;transaction-id&#39;: 8055, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 8150, &#39;amount&#39;: 38},
   {&#39;transaction-id&#39;: 8185, &#39;amount&#39;: 37},
   {&#39;transaction-id&#39;: 8428, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 8497, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 8563, &#39;amount&#39;: 33},
   {&#39;transaction-id&#39;: 8690, &#39;amount&#39;: 35},
   {&#39;transaction-id&#39;: 8910, &#39;amount&#39;: 36},
   {&#39;transaction-id&#39;: 9489, &#39;amount&#39;: 32},
   {&#39;transaction-id&#39;: 9649, &#39;amount&#39;: 34},
   {&#39;transaction-id&#39;: 9665, &#39;amount&#39;: 35},
   {&#39;transaction-id&#39;: 9797, &#39;amount&#39;: 33}]})
</pre></div></div>
</div>
</div>
<div class="section" id="Basic-Queries">
<h3>Basic Queries<a class="headerlink" href="#Basic-Queries" title="Permalink to this headline">¶</a></h3>
<p>Once we parse our JSON data into proper Python objects (<code class="docutils literal notranslate"><span class="pre">dict</span></code>s, <code class="docutils literal notranslate"><span class="pre">list</span></code>s, etc.) we can perform more interesting queries by creating small Python functions to run on our data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># filter: keep only some elements of the sequence</span>
<span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
({&#39;id&#39;: 5,
  &#39;name&#39;: &#39;Alice&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 214, &#39;amount&#39;: 528},
   {&#39;transaction-id&#39;: 259, &#39;amount&#39;: 496},
   {&#39;transaction-id&#39;: 523, &#39;amount&#39;: 486},
   {&#39;transaction-id&#39;: 568, &#39;amount&#39;: 504},
   {&#39;transaction-id&#39;: 616, &#39;amount&#39;: 508},
   {&#39;transaction-id&#39;: 653, &#39;amount&#39;: 466},
   {&#39;transaction-id&#39;: 757, &#39;amount&#39;: 514},
   {&#39;transaction-id&#39;: 842, &#39;amount&#39;: 508},
   {&#39;transaction-id&#39;: 875, &#39;amount&#39;: 487},
   {&#39;transaction-id&#39;: 939, &#39;amount&#39;: 503},
   {&#39;transaction-id&#39;: 969, &#39;amount&#39;: 528},
   {&#39;transaction-id&#39;: 1137, &#39;amount&#39;: 501},
   {&#39;transaction-id&#39;: 1231, &#39;amount&#39;: 527},
   {&#39;transaction-id&#39;: 1261, &#39;amount&#39;: 509},
   {&#39;transaction-id&#39;: 1356, &#39;amount&#39;: 480},
   {&#39;transaction-id&#39;: 1770, &#39;amount&#39;: 496},
   {&#39;transaction-id&#39;: 1815, &#39;amount&#39;: 527},
   {&#39;transaction-id&#39;: 2185, &#39;amount&#39;: 521},
   {&#39;transaction-id&#39;: 2268, &#39;amount&#39;: 472},
   {&#39;transaction-id&#39;: 2434, &#39;amount&#39;: 509},
   {&#39;transaction-id&#39;: 2521, &#39;amount&#39;: 520},
   {&#39;transaction-id&#39;: 2533, &#39;amount&#39;: 503},
   {&#39;transaction-id&#39;: 2536, &#39;amount&#39;: 523},
   {&#39;transaction-id&#39;: 2546, &#39;amount&#39;: 524},
   {&#39;transaction-id&#39;: 2694, &#39;amount&#39;: 514},
   {&#39;transaction-id&#39;: 2966, &#39;amount&#39;: 510},
   {&#39;transaction-id&#39;: 3022, &#39;amount&#39;: 524},
   {&#39;transaction-id&#39;: 3122, &#39;amount&#39;: 530},
   {&#39;transaction-id&#39;: 3202, &#39;amount&#39;: 527},
   {&#39;transaction-id&#39;: 3762, &#39;amount&#39;: 529},
   {&#39;transaction-id&#39;: 4012, &#39;amount&#39;: 503},
   {&#39;transaction-id&#39;: 4062, &#39;amount&#39;: 507},
   {&#39;transaction-id&#39;: 4080, &#39;amount&#39;: 510},
   {&#39;transaction-id&#39;: 4083, &#39;amount&#39;: 504},
   {&#39;transaction-id&#39;: 4559, &#39;amount&#39;: 453},
   {&#39;transaction-id&#39;: 4730, &#39;amount&#39;: 533},
   {&#39;transaction-id&#39;: 4792, &#39;amount&#39;: 515},
   {&#39;transaction-id&#39;: 4945, &#39;amount&#39;: 514},
   {&#39;transaction-id&#39;: 5190, &#39;amount&#39;: 522},
   {&#39;transaction-id&#39;: 5468, &#39;amount&#39;: 532},
   {&#39;transaction-id&#39;: 6065, &#39;amount&#39;: 505},
   {&#39;transaction-id&#39;: 6167, &#39;amount&#39;: 509},
   {&#39;transaction-id&#39;: 6368, &#39;amount&#39;: 514},
   {&#39;transaction-id&#39;: 6379, &#39;amount&#39;: 520},
   {&#39;transaction-id&#39;: 6458, &#39;amount&#39;: 494},
   {&#39;transaction-id&#39;: 6539, &#39;amount&#39;: 503},
   {&#39;transaction-id&#39;: 6682, &#39;amount&#39;: 502},
   {&#39;transaction-id&#39;: 6847, &#39;amount&#39;: 507},
   {&#39;transaction-id&#39;: 6881, &#39;amount&#39;: 517},
   {&#39;transaction-id&#39;: 7235, &#39;amount&#39;: 499},
   {&#39;transaction-id&#39;: 7383, &#39;amount&#39;: 503},
   {&#39;transaction-id&#39;: 7521, &#39;amount&#39;: 495},
   {&#39;transaction-id&#39;: 7717, &#39;amount&#39;: 498},
   {&#39;transaction-id&#39;: 7774, &#39;amount&#39;: 499},
   {&#39;transaction-id&#39;: 7804, &#39;amount&#39;: 530},
   {&#39;transaction-id&#39;: 7810, &#39;amount&#39;: 521},
   {&#39;transaction-id&#39;: 7815, &#39;amount&#39;: 494},
   {&#39;transaction-id&#39;: 7873, &#39;amount&#39;: 501},
   {&#39;transaction-id&#39;: 8111, &#39;amount&#39;: 512},
   {&#39;transaction-id&#39;: 8117, &#39;amount&#39;: 479},
   {&#39;transaction-id&#39;: 8136, &#39;amount&#39;: 492},
   {&#39;transaction-id&#39;: 8154, &#39;amount&#39;: 490},
   {&#39;transaction-id&#39;: 8188, &#39;amount&#39;: 516},
   {&#39;transaction-id&#39;: 8228, &#39;amount&#39;: 515},
   {&#39;transaction-id&#39;: 8230, &#39;amount&#39;: 505},
   {&#39;transaction-id&#39;: 8234, &#39;amount&#39;: 506},
   {&#39;transaction-id&#39;: 8238, &#39;amount&#39;: 489},
   {&#39;transaction-id&#39;: 8350, &#39;amount&#39;: 526},
   {&#39;transaction-id&#39;: 8375, &#39;amount&#39;: 534},
   {&#39;transaction-id&#39;: 8426, &#39;amount&#39;: 490},
   {&#39;transaction-id&#39;: 8442, &#39;amount&#39;: 492},
   {&#39;transaction-id&#39;: 8614, &#39;amount&#39;: 479},
   {&#39;transaction-id&#39;: 8639, &#39;amount&#39;: 564},
   {&#39;transaction-id&#39;: 9069, &#39;amount&#39;: 536},
   {&#39;transaction-id&#39;: 9187, &#39;amount&#39;: 498},
   {&#39;transaction-id&#39;: 9277, &#39;amount&#39;: 494},
   {&#39;transaction-id&#39;: 9564, &#39;amount&#39;: 507},
   {&#39;transaction-id&#39;: 9578, &#39;amount&#39;: 516},
   {&#39;transaction-id&#39;: 9816, &#39;amount&#39;: 476}]},
 {&#39;id&#39;: 18,
  &#39;name&#39;: &#39;Alice&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 1217, &#39;amount&#39;: 978},
   {&#39;transaction-id&#39;: 4708, &#39;amount&#39;: 1024},
   {&#39;transaction-id&#39;: 5080, &#39;amount&#39;: 1306},
   {&#39;transaction-id&#39;: 6076, &#39;amount&#39;: 1189},
   {&#39;transaction-id&#39;: 8281, &#39;amount&#39;: 1180},
   {&#39;transaction-id&#39;: 9206, &#39;amount&#39;: 1273}]},
 {&#39;id&#39;: 38,
  &#39;name&#39;: &#39;Alice&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 3638, &#39;amount&#39;: 1545},
   {&#39;transaction-id&#39;: 3668, &#39;amount&#39;: 1481},
   {&#39;transaction-id&#39;: 3799, &#39;amount&#39;: 1496},
   {&#39;transaction-id&#39;: 4504, &#39;amount&#39;: 1497},
   {&#39;transaction-id&#39;: 4714, &#39;amount&#39;: 1457},
   {&#39;transaction-id&#39;: 5618, &#39;amount&#39;: 1529}]},
 {&#39;id&#39;: 52,
  &#39;name&#39;: &#39;Alice&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 691, &#39;amount&#39;: 349},
   {&#39;transaction-id&#39;: 2122, &#39;amount&#39;: 296},
   {&#39;transaction-id&#39;: 2214, &#39;amount&#39;: 282},
   {&#39;transaction-id&#39;: 2802, &#39;amount&#39;: 360},
   {&#39;transaction-id&#39;: 3549, &#39;amount&#39;: 365},
   {&#39;transaction-id&#39;: 3673, &#39;amount&#39;: 348},
   {&#39;transaction-id&#39;: 3913, &#39;amount&#39;: 388},
   {&#39;transaction-id&#39;: 5784, &#39;amount&#39;: 323},
   {&#39;transaction-id&#39;: 6684, &#39;amount&#39;: 343},
   {&#39;transaction-id&#39;: 7350, &#39;amount&#39;: 316},
   {&#39;transaction-id&#39;: 8306, &#39;amount&#39;: 349},
   {&#39;transaction-id&#39;: 9774, &#39;amount&#39;: 340}]},
 {&#39;id&#39;: 85,
  &#39;name&#39;: &#39;Alice&#39;,
  &#39;transactions&#39;: [{&#39;transaction-id&#39;: 198, &#39;amount&#39;: 3111},
   {&#39;transaction-id&#39;: 367, &#39;amount&#39;: 3132},
   {&#39;transaction-id&#39;: 572, &#39;amount&#39;: 3172},
   {&#39;transaction-id&#39;: 1723, &#39;amount&#39;: 3057},
   {&#39;transaction-id&#39;: 2234, &#39;amount&#39;: 3132},
   {&#39;transaction-id&#39;: 2985, &#39;amount&#39;: 3044},
   {&#39;transaction-id&#39;: 5113, &#39;amount&#39;: 3194},
   {&#39;transaction-id&#39;: 5318, &#39;amount&#39;: 2939},
   {&#39;transaction-id&#39;: 6411, &#39;amount&#39;: 3050},
   {&#39;transaction-id&#39;: 8325, &#39;amount&#39;: 3050}]})
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">count_transactions</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">])}</span>

<span class="c1"># map: apply a function to each element</span>
<span class="p">(</span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">count_transactions</span><span class="p">)</span>
   <span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
({&#39;name&#39;: &#39;Alice&#39;, &#39;count&#39;: 79},
 {&#39;name&#39;: &#39;Alice&#39;, &#39;count&#39;: 6},
 {&#39;name&#39;: &#39;Alice&#39;, &#39;count&#39;: 6},
 {&#39;name&#39;: &#39;Alice&#39;, &#39;count&#39;: 12},
 {&#39;name&#39;: &#39;Alice&#39;, &#39;count&#39;: 10})
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># pluck: select a field, as from a dictionary, element[field]</span>
<span class="p">(</span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">count_transactions</span><span class="p">)</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(79, 6, 6, 12, 10)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Average number of transactions for all of the Alice entries</span>
<span class="p">(</span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">count_transactions</span><span class="p">)</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
   <span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
40.32293986636971
</pre></div></div>
</div>
</div>
<div class="section" id="Use-flatten-to-de-nest">
<h3>Use <code class="docutils literal notranslate"><span class="pre">flatten</span></code> to de-nest<a class="headerlink" href="#Use-flatten-to-de-nest" title="Permalink to this headline">¶</a></h3>
<p>In the example below we see the use of <code class="docutils literal notranslate"><span class="pre">.flatten()</span></code> to flatten results. We compute the average amount for all transactions for all Alices.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;transactions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
([{&#39;transaction-id&#39;: 214, &#39;amount&#39;: 528},
  {&#39;transaction-id&#39;: 259, &#39;amount&#39;: 496},
  {&#39;transaction-id&#39;: 523, &#39;amount&#39;: 486},
  {&#39;transaction-id&#39;: 568, &#39;amount&#39;: 504},
  {&#39;transaction-id&#39;: 616, &#39;amount&#39;: 508},
  {&#39;transaction-id&#39;: 653, &#39;amount&#39;: 466},
  {&#39;transaction-id&#39;: 757, &#39;amount&#39;: 514},
  {&#39;transaction-id&#39;: 842, &#39;amount&#39;: 508},
  {&#39;transaction-id&#39;: 875, &#39;amount&#39;: 487},
  {&#39;transaction-id&#39;: 939, &#39;amount&#39;: 503},
  {&#39;transaction-id&#39;: 969, &#39;amount&#39;: 528},
  {&#39;transaction-id&#39;: 1137, &#39;amount&#39;: 501},
  {&#39;transaction-id&#39;: 1231, &#39;amount&#39;: 527},
  {&#39;transaction-id&#39;: 1261, &#39;amount&#39;: 509},
  {&#39;transaction-id&#39;: 1356, &#39;amount&#39;: 480},
  {&#39;transaction-id&#39;: 1770, &#39;amount&#39;: 496},
  {&#39;transaction-id&#39;: 1815, &#39;amount&#39;: 527},
  {&#39;transaction-id&#39;: 2185, &#39;amount&#39;: 521},
  {&#39;transaction-id&#39;: 2268, &#39;amount&#39;: 472},
  {&#39;transaction-id&#39;: 2434, &#39;amount&#39;: 509},
  {&#39;transaction-id&#39;: 2521, &#39;amount&#39;: 520},
  {&#39;transaction-id&#39;: 2533, &#39;amount&#39;: 503},
  {&#39;transaction-id&#39;: 2536, &#39;amount&#39;: 523},
  {&#39;transaction-id&#39;: 2546, &#39;amount&#39;: 524},
  {&#39;transaction-id&#39;: 2694, &#39;amount&#39;: 514},
  {&#39;transaction-id&#39;: 2966, &#39;amount&#39;: 510},
  {&#39;transaction-id&#39;: 3022, &#39;amount&#39;: 524},
  {&#39;transaction-id&#39;: 3122, &#39;amount&#39;: 530},
  {&#39;transaction-id&#39;: 3202, &#39;amount&#39;: 527},
  {&#39;transaction-id&#39;: 3762, &#39;amount&#39;: 529},
  {&#39;transaction-id&#39;: 4012, &#39;amount&#39;: 503},
  {&#39;transaction-id&#39;: 4062, &#39;amount&#39;: 507},
  {&#39;transaction-id&#39;: 4080, &#39;amount&#39;: 510},
  {&#39;transaction-id&#39;: 4083, &#39;amount&#39;: 504},
  {&#39;transaction-id&#39;: 4559, &#39;amount&#39;: 453},
  {&#39;transaction-id&#39;: 4730, &#39;amount&#39;: 533},
  {&#39;transaction-id&#39;: 4792, &#39;amount&#39;: 515},
  {&#39;transaction-id&#39;: 4945, &#39;amount&#39;: 514},
  {&#39;transaction-id&#39;: 5190, &#39;amount&#39;: 522},
  {&#39;transaction-id&#39;: 5468, &#39;amount&#39;: 532},
  {&#39;transaction-id&#39;: 6065, &#39;amount&#39;: 505},
  {&#39;transaction-id&#39;: 6167, &#39;amount&#39;: 509},
  {&#39;transaction-id&#39;: 6368, &#39;amount&#39;: 514},
  {&#39;transaction-id&#39;: 6379, &#39;amount&#39;: 520},
  {&#39;transaction-id&#39;: 6458, &#39;amount&#39;: 494},
  {&#39;transaction-id&#39;: 6539, &#39;amount&#39;: 503},
  {&#39;transaction-id&#39;: 6682, &#39;amount&#39;: 502},
  {&#39;transaction-id&#39;: 6847, &#39;amount&#39;: 507},
  {&#39;transaction-id&#39;: 6881, &#39;amount&#39;: 517},
  {&#39;transaction-id&#39;: 7235, &#39;amount&#39;: 499},
  {&#39;transaction-id&#39;: 7383, &#39;amount&#39;: 503},
  {&#39;transaction-id&#39;: 7521, &#39;amount&#39;: 495},
  {&#39;transaction-id&#39;: 7717, &#39;amount&#39;: 498},
  {&#39;transaction-id&#39;: 7774, &#39;amount&#39;: 499},
  {&#39;transaction-id&#39;: 7804, &#39;amount&#39;: 530},
  {&#39;transaction-id&#39;: 7810, &#39;amount&#39;: 521},
  {&#39;transaction-id&#39;: 7815, &#39;amount&#39;: 494},
  {&#39;transaction-id&#39;: 7873, &#39;amount&#39;: 501},
  {&#39;transaction-id&#39;: 8111, &#39;amount&#39;: 512},
  {&#39;transaction-id&#39;: 8117, &#39;amount&#39;: 479},
  {&#39;transaction-id&#39;: 8136, &#39;amount&#39;: 492},
  {&#39;transaction-id&#39;: 8154, &#39;amount&#39;: 490},
  {&#39;transaction-id&#39;: 8188, &#39;amount&#39;: 516},
  {&#39;transaction-id&#39;: 8228, &#39;amount&#39;: 515},
  {&#39;transaction-id&#39;: 8230, &#39;amount&#39;: 505},
  {&#39;transaction-id&#39;: 8234, &#39;amount&#39;: 506},
  {&#39;transaction-id&#39;: 8238, &#39;amount&#39;: 489},
  {&#39;transaction-id&#39;: 8350, &#39;amount&#39;: 526},
  {&#39;transaction-id&#39;: 8375, &#39;amount&#39;: 534},
  {&#39;transaction-id&#39;: 8426, &#39;amount&#39;: 490},
  {&#39;transaction-id&#39;: 8442, &#39;amount&#39;: 492},
  {&#39;transaction-id&#39;: 8614, &#39;amount&#39;: 479},
  {&#39;transaction-id&#39;: 8639, &#39;amount&#39;: 564},
  {&#39;transaction-id&#39;: 9069, &#39;amount&#39;: 536},
  {&#39;transaction-id&#39;: 9187, &#39;amount&#39;: 498},
  {&#39;transaction-id&#39;: 9277, &#39;amount&#39;: 494},
  {&#39;transaction-id&#39;: 9564, &#39;amount&#39;: 507},
  {&#39;transaction-id&#39;: 9578, &#39;amount&#39;: 516},
  {&#39;transaction-id&#39;: 9816, &#39;amount&#39;: 476}],
 [{&#39;transaction-id&#39;: 1217, &#39;amount&#39;: 978},
  {&#39;transaction-id&#39;: 4708, &#39;amount&#39;: 1024},
  {&#39;transaction-id&#39;: 5080, &#39;amount&#39;: 1306},
  {&#39;transaction-id&#39;: 6076, &#39;amount&#39;: 1189},
  {&#39;transaction-id&#39;: 8281, &#39;amount&#39;: 1180},
  {&#39;transaction-id&#39;: 9206, &#39;amount&#39;: 1273}],
 [{&#39;transaction-id&#39;: 3638, &#39;amount&#39;: 1545},
  {&#39;transaction-id&#39;: 3668, &#39;amount&#39;: 1481},
  {&#39;transaction-id&#39;: 3799, &#39;amount&#39;: 1496},
  {&#39;transaction-id&#39;: 4504, &#39;amount&#39;: 1497},
  {&#39;transaction-id&#39;: 4714, &#39;amount&#39;: 1457},
  {&#39;transaction-id&#39;: 5618, &#39;amount&#39;: 1529}])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;transactions&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
   <span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
({&#39;transaction-id&#39;: 214, &#39;amount&#39;: 528},
 {&#39;transaction-id&#39;: 259, &#39;amount&#39;: 496},
 {&#39;transaction-id&#39;: 523, &#39;amount&#39;: 486})
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;transactions&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(528, 496, 486)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">js</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;transactions&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
   <span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
   <span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
787.181690140845
</pre></div></div>
</div>
</div>
<div class="section" id="Groupby-and-Foldby">
<h3>Groupby and Foldby<a class="headerlink" href="#Groupby-and-Foldby" title="Permalink to this headline">¶</a></h3>
<p>Often we want to group data by some function or key. We can do this either with the <code class="docutils literal notranslate"><span class="pre">.groupby</span></code> method, which is straightforward but forces a full shuffle of the data (expensive) or with the harder-to-use but faster <code class="docutils literal notranslate"><span class="pre">.foldby</span></code> method, which does a streaming combined groupby and reduction.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">groupby</span></code>: Shuffles data so that all items with the same key are in the same key-value pair</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">foldby</span></code>: Walks through the data accumulating a result per key</p></li>
</ul>
<p><em>Note: the full groupby is particularly bad. In actual workloads you would do well to use ``foldby`` or switch to ``DataFrame``s if possible.</em></p>
</div>
<div class="section" id="groupby">
<h3><code class="docutils literal notranslate"><span class="pre">groupby</span></code><a class="headerlink" href="#groupby" title="Permalink to this headline">¶</a></h3>
<p>Groupby collects items in your collection so that all items with the same value under some function are collected together into a key-value pair.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">([</span><span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;Charlie&#39;</span><span class="p">,</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span> <span class="s1">&#39;Edith&#39;</span><span class="p">,</span> <span class="s1">&#39;Frank&#39;</span><span class="p">])</span>
<span class="n">b</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># names grouped by length</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(7, [&#39;Charlie&#39;]), (3, [&#39;Bob&#39;, &#39;Dan&#39;]), (5, [&#39;Alice&#39;, &#39;Edith&#39;, &#39;Frank&#39;])]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="n">b</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(0, [0, 2, 4, 6, 8]), (1, [1, 3, 5, 7, 9])]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">b</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(0, 8), (1, 9)]
</pre></div></div>
</div>
</div>
<div class="section" id="foldby">
<h3><code class="docutils literal notranslate"><span class="pre">foldby</span></code><a class="headerlink" href="#foldby" title="Permalink to this headline">¶</a></h3>
<p>Foldby can be quite odd at first. It is similar to the following functions from other libraries:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">`toolz.reduceby</span></code> &lt;<a class="reference external" href="http://toolz.readthedocs.io/en/latest/streaming-analytics.html#streaming-split-apply-combine">http://toolz.readthedocs.io/en/latest/streaming-analytics.html#streaming-split-apply-combine</a>&gt;`__</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">`pyspark.RDD.combineByKey</span></code> &lt;<a class="reference external" href="http://abshinn.github.io/python/apache-spark/2014/10/11/using-combinebykey-in-apache-spark/">http://abshinn.github.io/python/apache-spark/2014/10/11/using-combinebykey-in-apache-spark/</a>&gt;`__</p></li>
</ul>
<p>When using <code class="docutils literal notranslate"><span class="pre">foldby</span></code> you provide</p>
<ol class="arabic simple">
<li><p>A key function on which to group elements</p></li>
<li><p>A binary operator such as you would pass to <code class="docutils literal notranslate"><span class="pre">reduce</span></code> that you use to perform reduction per each group</p></li>
<li><p>A combine binary operator that can combine the results of two <code class="docutils literal notranslate"><span class="pre">reduce</span></code> calls on different parts of your dataset.</p></li>
</ol>
<p>Your reduction must be associative. It will happen in parallel in each of the partitions of your dataset. Then all of these intermediate results will be combined by the <code class="docutils literal notranslate"><span class="pre">combine</span></code> binary operator.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">is_even</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span>
<span class="n">b</span><span class="o">.</span><span class="n">foldby</span><span class="p">(</span><span class="n">is_even</span><span class="p">,</span> <span class="n">binop</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="nb">max</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(0, 8), (1, 9)]
</pre></div></div>
</div>
</div>
<div class="section" id="Example-with-account-data">
<h3>Example with account data<a class="headerlink" href="#Example-with-account-data" title="Permalink to this headline">¶</a></h3>
<p>We find the number of people with the same name.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># Warning, this one takes a while...</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;Alice&#39;, 215), (&#39;Alice&#39;, 216), (&#39;Alice&#39;, 233), (&#39;Alice&#39;, 234), (&#39;Bob&#39;, 132), (&#39;Bob&#39;, 132), (&#39;Bob&#39;, 143), (&#39;Bob&#39;, 143), (&#39;Charlie&#39;, 84), (&#39;Charlie&#39;, 84), (&#39;Charlie&#39;, 90), (&#39;Charlie&#39;, 91), (&#39;Dan&#39;, 90), (&#39;Dan&#39;, 94), (&#39;Dan&#39;, 97), (&#39;Dan&#39;, 101), (&#39;Edith&#39;, 206), (&#39;Edith&#39;, 207), (&#39;Edith&#39;, 223), (&#39;Edith&#39;, 223), (&#39;Frank&#39;, 118), (&#39;Frank&#39;, 119), (&#39;Frank&#39;, 127), (&#39;Frank&#39;, 128), (&#39;George&#39;, 72), (&#39;George&#39;, 72), (&#39;George&#39;, 78), (&#39;George&#39;, 78), (&#39;Hannah&#39;, 128), (&#39;Hannah&#39;, 135), (&#39;Hannah&#39;, 141), (&#39;Hannah&#39;, 141), (&#39;Ingrid&#39;, 66), (&#39;Ingrid&#39;, 67), (&#39;Ingrid&#39;, 130), (&#39;Jerry&#39;, 82), (&#39;Jerry&#39;, 82), (&#39;Jerry&#39;, 88), (&#39;Jerry&#39;, 90), (&#39;Kevin&#39;, 59), (&#39;Kevin&#39;, 60), (&#39;Kevin&#39;, 65), (&#39;Kevin&#39;, 65), (&#39;Laura&#39;, 70), (&#39;Laura&#39;, 75), (&#39;Laura&#39;, 81), (&#39;Laura&#39;, 82), (&#39;Michael&#39;, 129), (&#39;Michael&#39;, 131), (&#39;Michael&#39;, 136), (&#39;Michael&#39;, 141), (&#39;Norbert&#39;, 94), (&#39;Norbert&#39;, 95), (&#39;Norbert&#39;, 101), (&#39;Norbert&#39;, 103), (&#39;Oliver&#39;, 96), (&#39;Oliver&#39;, 96), (&#39;Oliver&#39;, 104), (&#39;Oliver&#39;, 104), (&#39;Patricia&#39;, 120), (&#39;Patricia&#39;, 120), (&#39;Patricia&#39;, 130), (&#39;Patricia&#39;, 130), (&#39;Quinn&#39;, 72), (&#39;Quinn&#39;, 78), (&#39;Quinn&#39;, 150), (&#39;Ray&#39;, 96), (&#39;Ray&#39;, 96), (&#39;Ray&#39;, 104), (&#39;Ray&#39;, 104), (&#39;Sarah&#39;, 132), (&#39;Sarah&#39;, 132), (&#39;Sarah&#39;, 143), (&#39;Sarah&#39;, 143), (&#39;Tim&#39;, 144), (&#39;Tim&#39;, 144), (&#39;Tim&#39;, 155), (&#39;Tim&#39;, 159), (&#39;Ursula&#39;, 120), (&#39;Ursula&#39;, 120), (&#39;Ursula&#39;, 130), (&#39;Ursula&#39;, 130), (&#39;Victor&#39;, 60), (&#39;Victor&#39;, 60), (&#39;Victor&#39;, 65), (&#39;Victor&#39;, 65), (&#39;Wendy&#39;, 96), (&#39;Wendy&#39;, 96), (&#39;Wendy&#39;, 104), (&#39;Wendy&#39;, 104), (&#39;Xavier&#39;, 156), (&#39;Xavier&#39;, 156), (&#39;Xavier&#39;, 169), (&#39;Xavier&#39;, 169), (&#39;Yvonne&#39;, 96), (&#39;Yvonne&#39;, 96), (&#39;Yvonne&#39;, 104), (&#39;Yvonne&#39;, 104), (&#39;Zelda&#39;, 153), (&#39;Zelda&#39;, 154), (&#39;Zelda&#39;, 167), (&#39;Zelda&#39;, 167)]
CPU times: user 1.65 s, sys: 119 ms, total: 1.77 s
Wall time: 9.11 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># This one is comparatively fast and produces the same result.</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">add</span>
<span class="k">def</span> <span class="nf">incr</span><span class="p">(</span><span class="n">tot</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tot</span><span class="o">+</span><span class="mi">1</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">foldby</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                   <span class="n">binop</span><span class="o">=</span><span class="n">incr</span><span class="p">,</span>
                   <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">combine</span><span class="o">=</span><span class="n">add</span><span class="p">,</span>
                   <span class="n">combine_initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;Alice&#39;, 898), (&#39;Bob&#39;, 550), (&#39;Charlie&#39;, 349), (&#39;Dan&#39;, 382), (&#39;Edith&#39;, 859), (&#39;Frank&#39;, 492), (&#39;George&#39;, 300), (&#39;Hannah&#39;, 545), (&#39;Ingrid&#39;, 263), (&#39;Jerry&#39;, 342), (&#39;Kevin&#39;, 249), (&#39;Laura&#39;, 308), (&#39;Michael&#39;, 537), (&#39;Norbert&#39;, 393), (&#39;Oliver&#39;, 400), (&#39;Patricia&#39;, 500), (&#39;Quinn&#39;, 300), (&#39;Ray&#39;, 400), (&#39;Sarah&#39;, 550), (&#39;Tim&#39;, 602), (&#39;Ursula&#39;, 500), (&#39;Victor&#39;, 250), (&#39;Wendy&#39;, 400), (&#39;Xavier&#39;, 650), (&#39;Yvonne&#39;, 400), (&#39;Zelda&#39;, 641)]
CPU times: user 144 ms, sys: 12.2 ms, total: 156 ms
Wall time: 590 ms
</pre></div></div>
</div>
</div>
<div class="section" id="Exercise:-compute-total-amount-per-name">
<h3>Exercise: compute total amount per name<a class="headerlink" href="#Exercise:-compute-total-amount-per-name" title="Permalink to this headline">¶</a></h3>
<p>We want to groupby (or foldby) the <code class="docutils literal notranslate"><span class="pre">name</span></code> key, then add up the all of the amounts for each name.</p>
<p>Steps</p>
<ol class="arabic">
<li><p>Create a small function that, given a dictionary like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span> <span class="s1">&#39;transactions&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">456</span><span class="p">}]}</span>
</pre></div>
</div>
<p>produces the sum of the amounts, e.g. <code class="docutils literal notranslate"><span class="pre">3</span></code></p>
</li>
<li><p>Slightly change the binary operator of the <code class="docutils literal notranslate"><span class="pre">foldby</span></code> example above so that the binary operator doesn’t count the number of entries, but instead accumulates the sum of the amounts.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Your code here...</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="DataFrames">
<h2>DataFrames<a class="headerlink" href="#DataFrames" title="Permalink to this headline">¶</a></h2>
<p>For the same reasons that Pandas is often faster than pure Python, <code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code> can be faster than <code class="docutils literal notranslate"><span class="pre">dask.bag</span></code>. We will work more with DataFrames later, but from for the bag point of view, they are frequently the end-point of the “messy” part of data ingestion—once the data can be made into a data-frame, then complex split-apply-combine logic will become much more straight-forward and efficient.</p>
<p>You can transform a bag with a simple tuple or flat dictionary structure into a <code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code> with the <code class="docutils literal notranslate"><span class="pre">to_dataframe</span></code> method.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df1</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">df1</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Frank</td>
      <td>[{'transaction-id': 1923, 'amount': 927}, {'tr...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Charlie</td>
      <td>[{'transaction-id': 184, 'amount': 561}, {'tra...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Xavier</td>
      <td>[{'transaction-id': 282, 'amount': 29}, {'tran...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>George</td>
      <td>[{'transaction-id': 10, 'amount': 6348}, {'tra...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>Tim</td>
      <td>[{'transaction-id': 102, 'amount': 794}, {'tra...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>This now looks like a well-defined DataFrame, and we can apply Pandas-like computations to it efficiently.</p>
<p>Using a Dask DataFrame, how long does it take to do our prior computation of numbers of people with the same name? It turns out that <code class="docutils literal notranslate"><span class="pre">dask.dataframe.groupby()</span></code> beats <code class="docutils literal notranslate"><span class="pre">dask.bag.groupby()</span></code> more than an order of magnitude; but it still cannot match <code class="docutils literal notranslate"><span class="pre">dask.bag.foldby()</span></code> for this case.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">time</span> df1.groupby(&#39;name&#39;).id.count().compute().head()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 228 ms, sys: 8.73 ms, total: 237 ms
Wall time: 1.78 s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
name
Alice      898
Bob        550
Charlie    349
Dan        382
Edith      859
Name: id, dtype: int64
</pre></div></div>
</div>
<div class="section" id="Denormalization">
<h3>Denormalization<a class="headerlink" href="#Denormalization" title="Permalink to this headline">¶</a></h3>
<p>This DataFrame format is less-than-optimal because the <code class="docutils literal notranslate"><span class="pre">transactions</span></code> column is filled with nested data so Pandas has to revert to <code class="docutils literal notranslate"><span class="pre">object</span></code> dtype, which is quite slow in Pandas. Ideally we want to transform to a dataframe only after we have flattened our data so that each record is a single <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">string</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, etc..</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">denormalize</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># returns a list for every nested item, each transaction of each person</span>
    <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
             <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
             <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
             <span class="s1">&#39;transaction-id&#39;</span><span class="p">:</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;transaction-id&#39;</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]]</span>

<span class="n">transactions</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">denormalize</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">transactions</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
({&#39;id&#39;: 0, &#39;name&#39;: &#39;Frank&#39;, &#39;amount&#39;: 927, &#39;transaction-id&#39;: 1923},
 {&#39;id&#39;: 0, &#39;name&#39;: &#39;Frank&#39;, &#39;amount&#39;: 853, &#39;transaction-id&#39;: 3779},
 {&#39;id&#39;: 1, &#39;name&#39;: &#39;Charlie&#39;, &#39;amount&#39;: 561, &#39;transaction-id&#39;: 184})
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>name</th>
      <th>amount</th>
      <th>transaction-id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Frank</td>
      <td>927</td>
      <td>1923</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>Frank</td>
      <td>853</td>
      <td>3779</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>Charlie</td>
      <td>561</td>
      <td>184</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>Charlie</td>
      <td>546</td>
      <td>591</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>Charlie</td>
      <td>551</td>
      <td>1235</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># number of transactions per name</span>
<span class="c1"># note that the time here includes the data load and ingestion</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[</span><span class="s1">&#39;transaction-id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 219 ms, sys: 6.22 ms, total: 226 ms
Wall time: 1.49 s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
name
Alice       36210
Bob         26915
Charlie      9905
Dan         17834
Edith       38504
Frank       19323
George      13186
Hannah      35777
Ingrid      15599
Jerry        7190
Kevin        5565
Laura        9722
Michael     17542
Norbert     28684
Oliver      17691
Patricia    29370
Quinn       15249
Ray         14202
Sarah       20532
Tim         13909
Ursula      15974
Victor       4145
Wendy       17898
Xavier      29169
Yvonne      12044
Zelda       27861
Name: transaction-id, dtype: int64
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Limitations">
<h2>Limitations<a class="headerlink" href="#Limitations" title="Permalink to this headline">¶</a></h2>
<p>Bags provide very general computation (any Python function.) This generality comes at cost. Bags have the following known limitations</p>
<ol class="arabic simple">
<li><p>Bag operations tend to be slower than array/dataframe computations in the same way that Python tends to be slower than NumPy/Pandas</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Bag.groupby</span></code> is slow. You should try to use <code class="docutils literal notranslate"><span class="pre">Bag.foldby</span></code> if possible. Using <code class="docutils literal notranslate"><span class="pre">Bag.foldby</span></code> requires more thought. Even better, consider creating a normalised dataframe.</p></li>
</ol>
</div>
<div class="section" id="Learn-More">
<h2>Learn More<a class="headerlink" href="#Learn-More" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/bag.html">Bag documentation</a></p></li>
<li><p><a class="reference external" href="https://youtu.be/-qIiJ1XtSv0">Bag screencast</a></p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/bag-api.html">Bag API</a></p></li>
<li><p><a class="reference external" href="https://examples.dask.org/bag.html">Bag examples</a></p></li>
</ul>
</div>
<div class="section" id="Shutdown">
<h2>Shutdown<a class="headerlink" href="#Shutdown" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="03_array.html" class="btn btn-neutral float-right" title="Arrays" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="01x_lazy.html" class="btn btn-neutral float-left" title="Lazy execution" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018, Dask Developers

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>